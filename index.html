<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STM Garage Recruitment</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #1e1e2f;
    color: #f0f0f0;
    margin: 0;
    padding: 0;
  }
  header {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    background: #27293d;
    height:60px;
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 0 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    z-index: 100;
  }
  header h1 {
    margin:0;
    font-size:1.2rem;
    display:flex;
    align-items:center;
    gap:10px;
  }
  header h1 img {
    height:40px;
    border-radius:8px;
  }
  .hamburger {
    cursor:pointer;
    width:30px;
    height:22px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .hamburger div {
    height:4px;
    background:#f0f0f0;
    border-radius:2px;
    transition: all 0.3s ease;
  }
  nav {
    position: fixed;
    top:60px;
    right:-250px;
    width: 250px;
    background:#343656;
    height:100%;
    transition: right 0.3s ease;
    padding:20px;
    box-shadow: -2px 0 6px rgba(0,0,0,0.5);
  }
  nav a {
    display:block;
    color:#f0f0f0;
    text-decoration:none;
    margin-bottom:15px;
    font-weight:bold;
  }
  nav.show {
    right:0;
  }
  main {
    margin-top:80px;
    padding:20px;
    max-width:600px;
    margin-left:auto;
    margin-right:auto;
  }
  .card {
    background:#27293d;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.5);
    margin-bottom:20px;
    transition: transform 0.3s ease;
  }
  .card:hover {
    transform: translateY(-5px);
  }
  label { display:block; margin-top:10px; }
  input, textarea, select {
    width:100%;
    padding:10px;
    margin-top:5px;
    border-radius:6px;
    border:none;
    background:#1e1e2f;
    color:#f0f0f0;
  }
  button {
    margin-top:15px;
    padding:10px 15px;
    background:#5c6bc0;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    transition: background 0.3s;
  }
  button:hover { background:#3f51b5; }
  .hidden { display:none; }
  #riwayatList button {
    margin-right:5px;
    margin-top:5px;
    padding:5px 8px;
    background:#43a047;
    border-radius:6px;
  }
  #riwayatList button:last-child { background:#e53935; }
</style>
</head>
<body>

<header>
  <h1>
    <img src="logo.png" alt="STM Logo"> STM Garage Recruitment
  </h1>
  <div class="hamburger" id="hamburger">
    <div></div>
    <div></div>
    <div></div>
  </div>
</header>

<nav id="menu">
  <a href="https://discord.com" target="_blank">Link Discord</a>
  <a href="#">Tentang STM Company</a>
  <a href="#" id="logoutBtn">Logout</a>
</nav>

<main>
  <!-- Login Card -->
  <div id="loginCard" class="card">
    <h2>Login Discord</h2>
    <button id="loginBtn">Login dengan Discord</button>
  </div>

  <!-- Form Lamaran -->
  <div id="formCard" class="card hidden">
    <h2>Form Lamaran</h2>
    <form id="lamaranForm" enctype="multipart/form-data">
      <label>NAMA IC:</label>
      <input type="text" name="namaIC" required>
      <label>LEVEL IC:</label>
      <input type="text" name="levelIC" required>
      <label>ALASAN BERGABUNG KE STM:</label>
      <textarea name="alasan" required></textarea>
      <label>NOTE (opsional):</label>
      <textarea name="note"></textarea>
      <label>TAG:</label>
      <select name="tag" required>
        <option value="Manager">Manager</option>
        <option value="Asisten">Asisten</option>
        <option value="Supervisor">Supervisor</option>
        <option value="Staff Senior">Staff Senior</option>
        <option value="Koordinator">Koordinator</option>
      </select>
      <label>SS STATS / TAB (opsional):</label>
      <input type="file" name="file" accept="image/*">
      <button type="submit">Kirim Lamaran</button>
    </form>
  </div>

  <!-- Riwayat Lamaran -->
  <div id="riwayatCard" class="card hidden">
    <h2>Riwayat Lamaran</h2>
    <div id="riwayatList"></div>
  </div>
</main>

<script>
  const hamburger = document.getElementById("hamburger");
  const menu = document.getElementById("menu");
  hamburger.addEventListener("click", () => menu.classList.toggle("show"));

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginCard = document.getElementById("loginCard");
  const formCard = document.getElementById("formCard");
  const riwayatCard = document.getElementById("riwayatCard");
  const riwayatList = document.getElementById("riwayatList");
  const lamaranForm = document.getElementById("lamaranForm");

  async function checkLogin() {
    const res = await fetch("/me");
    const data = await res.json();
    if(data.logged_in) {
      loginCard.classList.add("hidden");
      formCard.classList.remove("hidden");
      riwayatCard.classList.remove("hidden");
      loadRiwayat();
    } else {
      loginCard.classList.remove("hidden");
      formCard.classList.add("hidden");
      riwayatCard.classList.add("hidden");
    }
  }

  async function loadRiwayat() {
    const res = await fetch("/riwayat");
    const data = await res.json();
    riwayatList.innerHTML = "";
    data.forEach(l => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #444";
      div.style.padding = "5px 0";
      div.innerHTML = `
        <strong>${l.namaIC}</strong> (${l.tag}) - Status: ${l.status}<br>
        Alasan: ${l.alasan}<br>
        Note: ${l.note}<br>
        Discord: ${l.discord_user.username}
      `;
      // tombol update status jika role sesuai
      if(l.discord_user.can_update) {
        div.innerHTML += `
          <button onclick="updateStatus('${l.id}','Diterima')">Terima</button>
          <button onclick="updateStatus('${l.id}','Ditolak')">Tolak</button>
        `;
      }
      riwayatList.appendChild(div);
    });
  }

  async function updateStatus(id,status){
    const res = await fetch("/update_status",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id,status})
    });
    const data = await res.json();
    if(data.success) loadRiwayat();
    else alert(data.error);
  }

  loginBtn.addEventListener("click", ()=>{ window.location.href="/login"; });
  logoutBtn.addEventListener("click", async ()=>{
    await fetch("/logout");
    checkLogin();
  });

  lamaranForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const formData = new FormData(lamaranForm);
    const res = await fetch("/submit", {method:"POST", body:formData});
    const data = await res.json();
    if(data.success){
      alert("Lamaran terkirim!");
      lamaranForm.reset();
      loadRiwayat();
    } else alert(data.error);
  });

  checkLogin();
</script>

</body>
</html>
